# 🎉 云托管部署成功 - 验证指南

## 部署信息

- **服务名称**: node-backend
- **服务类型**: 容器型云托管（支持 WebSocket）
- **部署时间**: 2025-11-08 23:46:14
- **运行状态**: ✅ normal
- **公网访问**: ✅ 已开启

## 一、获取服务访问地址

### 方法1：通过腾讯云控制台查看

1. 打开部署详情页面：
   ```
   https://tcb.cloud.tencent.com/dev?envId=cloud1-5gtce4ym5a28e1b9#/platform-run/service/detail?serverName=node-backend&tabId=deploy&envId=cloud1-5gtce4ym5a28e1b9
   ```

2. 在控制台中找到 **"访问配置"** 或 **"基本信息"** 标签

3. 复制服务的公网访问地址，格式通常为：
   ```
   https://node-backend-xxx.service.tcloudbase.com
   ```

### 方法2：通过 CLI 查看

```bash
# 查看服务列表
tcb cloudrun list -e cloud1-5gtce4ym5a28e1b9
```

## 二、验证部署是否成功

### 1. 健康检查接口

```bash
# 替换为您的实际服务地址
curl https://node-backend-xxx.service.tcloudbase.com/health
```

**预期响应**：
```json
{
  "status": "ok",
  "timestamp": 1699200000000,
  "service": "express-miniapp"
}
```

### 2. 环境诊断接口

```bash
curl https://node-backend-xxx.service.tcloudbase.com/diagnose
```

**检查要点**：
- ✅ `database.host` 不是 localhost（应该是内网地址）
- ✅ `hasPassword: true`
- ✅ `hasInternalConfig: true`
- ✅ `warning: null`（没有警告）

### 3. WebSocket 测试

使用提供的测试脚本：

```bash
# 编辑 test-websocket-connection.js，修改服务地址
# 然后运行测试
node test-websocket-connection.js
```

或者使用在线 WebSocket 测试工具：
- 工具地址: https://www.websocket.org/echo.html
- WebSocket URL: `wss://node-backend-xxx.service.tcloudbase.com/test-ws`

**预期行为**：
- ✅ 连接成功
- ✅ 收到欢迎消息
- ✅ 发送消息后收到回显

## 三、配置环境变量（重要！）

### 必须配置的环境变量

在腾讯云控制台的 **"环境变量"** 标签中配置：

#### 1. 数据库配置（内网地址）
```bash
DB_HOST_INTERNAL=10.x.x.x          # MySQL 内网地址
DB_PORT_INTERNAL=3306
DB_USER=root
DB_PASSWORD=你的数据库密码
DB_NAME=miniapp_db
```

#### 2. 微信小程序配置
```bash
WECHAT_APPID=你的小程序AppID
WECHAT_APPSECRET=你的小程序AppSecret
```

#### 3. JWT 配置
```bash
JWT_SECRET=你的强密码（至少32位随机字符串）
```

#### 4. 环境标识
```bash
NODE_ENV=production
```

### 配置步骤

1. 进入服务详情页
2. 点击 **"环境变量"** 标签
3. 点击 **"新增环境变量"**
4. 逐个添加上述变量
5. 点击 **"保存"** 后，服务会自动重启

## 四、测试核心功能

### 1. 小程序登录测试

```bash
# 使用小程序获取的 code 测试登录
curl -X POST https://node-backend-xxx.service.tcloudbase.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"code": "小程序登录code"}'
```

### 2. 天气功能测试

```bash
# 获取天气信息
curl "https://node-backend-xxx.service.tcloudbase.com/api/v1/weather/current?city=北京"
```

### 3. 实时语音识别测试

```bash
# 测试 WebSocket 流式识别
# 使用小程序端代码连接：
# wss://node-backend-xxx.service.tcloudbase.com/api/realtime-voice/stream
```

## 五、小程序端配置

### 1. 配置服务器域名

在微信小程序后台配置以下域名：

**request 合法域名**：
```
https://node-backend-xxx.service.tcloudbase.com
```

**socket 合法域名**：
```
wss://node-backend-xxx.service.tcloudbase.com
```

**uploadFile 合法域名**：
```
https://node-backend-xxx.service.tcloudbase.com
```

### 2. 更新小程序配置文件

编辑小程序的配置文件（如 `config.js`）：

```javascript
// config.js
const config = {
  // 生产环境
  production: {
    apiBaseUrl: 'https://node-backend-xxx.service.tcloudbase.com',
    wsBaseUrl: 'wss://node-backend-xxx.service.tcloudbase.com'
  },
  
  // 开发环境
  development: {
    apiBaseUrl: 'http://localhost',
    wsBaseUrl: 'ws://localhost'
  }
}

// 根据环境选择配置
const ENV = 'production' // 或 'development'
module.exports = config[ENV]
```

### 3. 小程序调用示例

```javascript
// 登录
wx.request({
  url: 'https://node-backend-xxx.service.tcloudbase.com/api/auth/login',
  method: 'POST',
  data: { code: res.code },
  success: (res) => {
    console.log('登录成功:', res.data)
    // 保存 token
    wx.setStorageSync('token', res.data.data.token)
  }
})

// WebSocket 连接
const ws = wx.connectSocket({
  url: 'wss://node-backend-xxx.service.tcloudbase.com/api/realtime-voice/stream',
  header: {
    'Authorization': 'Bearer ' + wx.getStorageSync('token')
  }
})
```

## 六、监控和日志

### 查看服务日志

1. 进入服务详情页
2. 点击 **"日志"** 标签
3. 查看实时日志和历史日志

### 常见日志关键词

- ✅ `数据库连接成功` - 数据库配置正确
- ✅ `WebSocket 连接成功` - WebSocket 工作正常
- ❌ `数据库连接失败` - 检查数据库配置
- ❌ `ECONNREFUSED` - 数据库地址不可达

## 七、常见问题排查

### 问题1：数据库连接失败

**症状**：访问 `/diagnose` 显示 localhost 或连接失败

**解决**：
1. 确认已配置 `DB_HOST_INTERNAL` 环境变量
2. 确认使用的是 MySQL 的**内网地址**（10.x.x.x）
3. 确认数据库密码正确
4. 重启服务使环境变量生效

### 问题2：WebSocket 连接失败

**症状**：WebSocket 连接超时或立即断开

**解决**：
1. 确认 `cloudbaserc.json` 中 `enableWebSocket: true`
2. 确认使用 `wss://` 协议（生产环境）
3. 检查小程序域名白名单配置
4. 查看服务日志确认 WebSocket 路由正常

### 问题3：小程序登录失败

**症状**：返回 40163 或其他微信错误码

**解决**：
1. 确认 `WECHAT_APPID` 和 `WECHAT_APPSECRET` 配置正确
2. 确认 code 未过期（5分钟有效期）
3. 确认小程序 AppID 与配置一致

### 问题4：Token 验证失败

**症状**：返回 401 Unauthorized

**解决**：
1. 确认 `JWT_SECRET` 已配置
2. 确认请求头携带了 token：`Authorization: Bearer xxx`
3. 确认 token 未过期

## 八、性能优化建议

### 1. 启用 CDN 加速

对于静态资源和 API 响应，可以考虑启用 CDN。

### 2. 配置自动扩缩容

在服务配置中设置：
- 最小实例数：1（保持服务常驻）
- 最大实例数：根据业务需求（如 5-10）
- CPU 阈值：70%

### 3. 数据库连接优化

当前配置已使用连接池，无需额外优化。

### 4. 日志级别

生产环境建议设置：
```bash
LOG_LEVEL=error  # 只记录错误日志，减少日志量
```

## 九、备份和回滚

### 查看历史版本

在控制台的 **"版本管理"** 标签可以看到所有部署版本。

### 回滚到上一版本

如果新版本有问题，可以快速回滚：
1. 进入 **"版本管理"**
2. 选择稳定的历史版本
3. 点击 **"回滚"**

## 十、下次部署

### 快速部署命令

```bash
# 进入项目目录
cd "C:\Users\admin\Desktop\cloudrun-express - 副本 (2) - 副本"

# 部署（使用 framework）
tcb framework deploy -e cloud1-5gtce4ym5a28e1b9

# 或者直接使用 cloudrun deploy
tcb cloudrun deploy -e cloud1-5gtce4ym5a28e1b9 -s node-backend --port 80 --source . --force
```

### 部署前检查清单

- [ ] 代码已提交到 Git
- [ ] 已在本地测试通过
- [ ] 环境变量已配置
- [ ] Dockerfile 正确
- [ ] cloudbaserc.json 配置正确

## 十一、获取帮助

### 官方文档
- 云托管文档: https://cloud.tencent.com/document/product/876/19391
- CloudBase CLI: https://docs.cloudbase.net/cli-v1/intro.html

### 技术支持
- 腾讯云工单系统
- CloudBase 开发者社区

---

## 快速验证脚本

创建一个快速验证脚本 `verify-deployment.sh`：

```bash
#!/bin/bash

# 设置您的服务地址
SERVICE_URL="https://node-backend-xxx.service.tcloudbase.com"

echo "开始验证部署..."
echo ""

# 1. 健康检查
echo "1. 健康检查..."
curl -s "$SERVICE_URL/health" | jq .
echo ""

# 2. 环境诊断
echo "2. 环境诊断..."
curl -s "$SERVICE_URL/diagnose" | jq .diagnosis
echo ""

# 3. WebSocket 测试
echo "3. WebSocket 测试..."
echo "请手动测试 WebSocket: wss://${SERVICE_URL#https://}/test-ws"
echo ""

echo "验证完成！"
```

使用方法：
```bash
# 修改脚本中的 SERVICE_URL
# 然后运行
bash verify-deployment.sh
```

---

**部署时间**: 2025-11-08 23:46:14  
**文档版本**: v1.0  
**最后更新**: 2025-11-08

