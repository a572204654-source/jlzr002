# Wordå¯¼å‡ºé”™è¯¯ä¿®å¤æŒ‡å—

## ğŸ”´ å½“å‰é”™è¯¯

```
å¯¼å‡ºWordå¤±è´¥ï¼š Error: ä¸‹è½½å¤±è´¥
at Object.success (request.js:240)
```

## ğŸ¯ é—®é¢˜åŸå› 

è¿™ä¸ªé”™è¯¯é€šå¸¸ç”±ä»¥ä¸‹åŸå› å¼•èµ·ï¼š

### 1. âŒ åŸŸåæœªé…ç½®ï¼ˆæœ€å¸¸è§ï¼‰
ä½¿ç”¨ `wx.downloadFile` æ—¶ï¼ŒåŸŸåå¿…é¡»åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®

### 2. âŒ ä½¿ç”¨äº†é”™è¯¯çš„APIæ–¹æ³•
å¯èƒ½ä½¿ç”¨äº† `wx.request` è€Œä¸æ˜¯ `wx.downloadFile`

### 3. âŒ Tokenæœªæ­£ç¡®ä¼ é€’
è®¤è¯ä¿¡æ¯æœªæ­£ç¡®æ·»åŠ åˆ°è¯·æ±‚å¤´

### 4. âŒ æ¥å£è·¯å¾„é”™è¯¯
åç«¯æ¥å£è·¯å¾„ä¸å‰ç«¯è°ƒç”¨ä¸åŒ¹é…

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šé…ç½®åŸŸåï¼ˆæ¨èï¼‰

å¦‚æœä½ æƒ³ä½¿ç”¨ `wx.downloadFile`ï¼ˆæœ€ç®€å•çš„æ–¹å¼ï¼‰ï¼š

#### æ­¥éª¤1ï¼šç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°
1. è®¿é—®ï¼šhttps://mp.weixin.qq.com
2. ä½¿ç”¨å°ç¨‹åºç®¡ç†å‘˜è´¦å·ç™»å½•

#### æ­¥éª¤2ï¼šé…ç½®åŸŸå
1. ç‚¹å‡»å·¦ä¾§èœå•ï¼š**å¼€å‘ç®¡ç†**
2. ç‚¹å‡»ï¼š**å¼€å‘è®¾ç½®**
3. æ‰¾åˆ°ï¼š**æœåŠ¡å™¨åŸŸå**
4. ç‚¹å‡» **downloadFileåˆæ³•åŸŸå** åçš„ **ä¿®æ”¹**
5. æ·»åŠ ä½ çš„åç«¯åŸŸåï¼ˆå¿…é¡»æ˜¯httpsï¼‰ï¼š
   ```
   https://your-domain.com
   ```
6. ä¿å­˜å¹¶ç­‰å¾…ç”Ÿæ•ˆï¼ˆé€šå¸¸ç«‹å³ç”Ÿæ•ˆï¼‰

#### æ­¥éª¤3ï¼šä½¿ç”¨æ­£ç¡®çš„ä»£ç 

åœ¨ä½ çš„ `profile-logs.vue` ä¸­æ›¿æ¢å¯¼å‡ºæ–¹æ³•ï¼š

```javascript
// âœ… æ­£ç¡®çš„å¯¼å‡ºæ–¹æ³•
handleExportWord() {
  const logId = this.currentLogId // æ ¹æ®ä½ çš„å®é™…å˜é‡åä¿®æ”¹
  
  // æ˜¾ç¤ºåŠ è½½
  wx.showLoading({
    title: 'æ­£åœ¨å¯¼å‡º...',
    mask: true
  })

  // è·å–token
  const token = wx.getStorageSync('token')
  
  if (!token) {
    wx.hideLoading()
    wx.showToast({
      title: 'è¯·å…ˆç™»å½•',
      icon: 'none'
    })
    return
  }

  // ä½ çš„åç«¯åœ°å€
  const BASE_URL = 'https://your-domain.com' // ä¿®æ”¹ä¸ºå®é™…åœ°å€

  // ä¸‹è½½Wordæ–‡æ¡£
  wx.downloadFile({
    url: `${BASE_URL}/api/supervision-logs/${logId}/export`,
    header: {
      'Authorization': `Bearer ${token}`
    },
    success(res) {
      wx.hideLoading()
      
      console.log('ä¸‹è½½å“åº”:', res) // ç”¨äºè°ƒè¯•
      
      if (res.statusCode === 200) {
        // æˆåŠŸï¼Œæ‰“å¼€æ–‡æ¡£
        wx.openDocument({
          filePath: res.tempFilePath,
          fileType: 'docx',
          showMenu: true,
          success() {
            wx.showToast({
              title: 'å¯¼å‡ºæˆåŠŸ',
              icon: 'success'
            })
          },
          fail(err) {
            console.error('æ‰“å¼€æ–‡æ¡£å¤±è´¥:', err)
            wx.showToast({
              title: 'æ‰“å¼€å¤±è´¥',
              icon: 'none'
            })
          }
        })
      } else if (res.statusCode === 401) {
        // Tokenè¿‡æœŸ
        wx.showModal({
          title: 'ç™»å½•å·²è¿‡æœŸ',
          content: 'è¯·é‡æ–°ç™»å½•',
          showCancel: false
        })
      } else if (res.statusCode === 404) {
        // æ—¥å¿—ä¸å­˜åœ¨
        wx.showToast({
          title: 'æ—¥å¿—ä¸å­˜åœ¨',
          icon: 'none'
        })
      } else {
        // å…¶ä»–é”™è¯¯
        wx.showToast({
          title: `å¯¼å‡ºå¤±è´¥(${res.statusCode})`,
          icon: 'none'
        })
      }
    },
    fail(err) {
      wx.hideLoading()
      console.error('ä¸‹è½½å¤±è´¥:', err)
      
      // è¯¦ç»†çš„é”™è¯¯æç¤º
      if (err.errMsg && err.errMsg.includes('domain')) {
        wx.showModal({
          title: 'åŸŸåæœªé…ç½®',
          content: 'è¯·åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½® downloadFile åˆæ³•åŸŸå',
          showCancel: false
        })
      } else {
        wx.showToast({
          title: err.errMsg || 'ä¸‹è½½å¤±è´¥',
          icon: 'none'
        })
      }
    }
  })
}
```

---

### æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ wx.requestï¼ˆæ— éœ€é…ç½®åŸŸåï¼‰

å¦‚æœä½ æš‚æ—¶æ— æ³•é…ç½®åŸŸåï¼Œå¯ä»¥ä½¿ç”¨ `wx.request`ï¼š

```javascript
handleExportWord() {
  const logId = this.currentLogId
  
  wx.showLoading({
    title: 'æ­£åœ¨å¯¼å‡º...',
    mask: true
  })

  const token = wx.getStorageSync('token')
  const BASE_URL = 'https://your-domain.com'

  wx.request({
    url: `${BASE_URL}/api/supervision-logs/${logId}/export`,
    method: 'GET',
    responseType: 'arraybuffer', // é‡è¦ï¼šæŒ‡å®šå“åº”ç±»å‹
    header: {
      'Authorization': `Bearer ${token}`
    },
    success(res) {
      wx.hideLoading()
      
      if (res.statusCode === 200) {
        // è·å–æ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨
        const fs = wx.getFileSystemManager()
        
        // ç”Ÿæˆä¸´æ—¶æ–‡ä»¶è·¯å¾„
        const fileName = `ç›‘ç†æ—¥å¿—_${logId}_${Date.now()}.docx`
        const filePath = `${wx.env.USER_DATA_PATH}/${fileName}`
        
        // å†™å…¥æ–‡ä»¶
        fs.writeFile({
          filePath: filePath,
          data: res.data,
          encoding: 'binary',
          success() {
            // æ‰“å¼€æ–‡æ¡£
            wx.openDocument({
              filePath: filePath,
              fileType: 'docx',
              showMenu: true,
              success() {
                wx.showToast({
                  title: 'å¯¼å‡ºæˆåŠŸ',
                  icon: 'success'
                })
              },
              fail(err) {
                console.error('æ‰“å¼€æ–‡æ¡£å¤±è´¥:', err)
                wx.showToast({
                  title: 'æ‰“å¼€å¤±è´¥',
                  icon: 'none'
                })
              }
            })
          },
          fail(err) {
            console.error('å†™å…¥æ–‡ä»¶å¤±è´¥:', err)
            wx.showToast({
              title: 'ä¿å­˜å¤±è´¥',
              icon: 'none'
            })
          }
        })
      } else {
        wx.showToast({
          title: `å¯¼å‡ºå¤±è´¥(${res.statusCode})`,
          icon: 'none'
        })
      }
    },
    fail(err) {
      wx.hideLoading()
      console.error('è¯·æ±‚å¤±è´¥:', err)
      wx.showToast({
        title: 'å¯¼å‡ºå¤±è´¥',
        icon: 'none'
      })
    }
  })
}
```

---

## ğŸ” è°ƒè¯•æ­¥éª¤

### 1. æ£€æŸ¥BASE_URLæ˜¯å¦æ­£ç¡®

```javascript
// åœ¨å¯¼å‡ºæ–¹æ³•å¼€å§‹æ—¶æ·»åŠ 
console.log('BASE_URL:', BASE_URL)
console.log('å®Œæ•´URL:', `${BASE_URL}/api/supervision-logs/${logId}/export`)
```

### 2. æ£€æŸ¥Tokenæ˜¯å¦æœ‰æ•ˆ

```javascript
// åœ¨å¯¼å‡ºæ–¹æ³•ä¸­æ·»åŠ 
const token = wx.getStorageSync('token')
console.log('Token:', token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨')
console.log('Tokené•¿åº¦:', token ? token.length : 0)
```

### 3. æ£€æŸ¥æ¥å£è·¯å¾„

ç¡®è®¤ä½ çš„åç«¯æ¥å£è·¯å¾„ï¼š
- âœ… `/api/supervision-logs/:id/export`
- âŒ `/api/v1/supervision-logs/:id/export`ï¼ˆå¦‚æœæ˜¯è¿™ä¸ªï¼Œéœ€è¦ä¿®æ”¹å‰ç«¯URLï¼‰

### 4. ä½¿ç”¨å¼€å‘å·¥å…·æµ‹è¯•

åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼š
1. ç‚¹å‡»å³ä¸Šè§’ **è¯¦æƒ…**
2. å‹¾é€‰ **ä¸æ ¡éªŒåˆæ³•åŸŸåã€web-viewï¼ˆä¸šåŠ¡åŸŸåï¼‰ã€TLSç‰ˆæœ¬ä»¥åŠHTTPSè¯ä¹¦**
3. é‡æ–°æµ‹è¯•å¯¼å‡ºåŠŸèƒ½

å¦‚æœå¼€å‘å·¥å…·ä¸­èƒ½æˆåŠŸï¼Œè¯´æ˜æ˜¯åŸŸåé…ç½®é—®é¢˜ã€‚

### 5. æŸ¥çœ‹ç½‘ç»œè¯·æ±‚

åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼š
1. ç‚¹å‡» **è°ƒè¯•å™¨** æ ‡ç­¾
2. åˆ‡æ¢åˆ° **Network** é¢æ¿
3. ç‚¹å‡»å¯¼å‡ºæŒ‰é’®
4. æŸ¥çœ‹è¯·æ±‚è¯¦æƒ…ï¼š
   - è¯·æ±‚URLæ˜¯å¦æ­£ç¡®
   - çŠ¶æ€ç æ˜¯å¤šå°‘
   - å“åº”å†…å®¹æ˜¯ä»€ä¹ˆ

---

## ğŸ“ å¸¸è§é”™è¯¯å¯¹ç…§è¡¨

| é”™è¯¯ä¿¡æ¯ | åŸå›  | è§£å†³æ–¹æ³• |
|---------|------|---------|
| `downloadFile:fail invalid url domain` | åŸŸåæœªé…ç½® | åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®åŸŸå |
| `statusCode: 401` | Tokenæ— æ•ˆæˆ–è¿‡æœŸ | é‡æ–°ç™»å½•è·å–æ–°token |
| `statusCode: 404` | æ—¥å¿—ä¸å­˜åœ¨æˆ–æ¥å£è·¯å¾„é”™è¯¯ | æ£€æŸ¥logIdå’Œæ¥å£è·¯å¾„ |
| `statusCode: 500` | åç«¯æœåŠ¡é”™è¯¯ | æŸ¥çœ‹åç«¯æ—¥å¿— |
| `request:fail` | ç½‘ç»œè¯·æ±‚å¤±è´¥ | æ£€æŸ¥ç½‘ç»œè¿æ¥ |
| `openDocument:fail` | æ–‡ä»¶æ‰“å¼€å¤±è´¥ | æ£€æŸ¥æ–‡ä»¶æ ¼å¼å’Œè·¯å¾„ |

---

## ğŸ¯ å®Œæ•´çš„å¯ç”¨ä»£ç ï¼ˆå¤åˆ¶ç²˜è´´å³å¯ï¼‰

### å¦‚æœä½ ä½¿ç”¨åŸç”Ÿå¾®ä¿¡å°ç¨‹åºï¼š

```javascript
// åœ¨ä½ çš„ profile-logs.vue æˆ– .js æ–‡ä»¶ä¸­

// é…ç½®é¡¹ï¼ˆä¿®æ”¹ä¸ºä½ çš„å®é™…å€¼ï¼‰
const CONFIG = {
  BASE_URL: 'https://your-domain.com', // ä½ çš„åç«¯åœ°å€
  TOKEN_KEY: 'token'                    // tokenåœ¨storageä¸­çš„key
}

// å¯¼å‡ºWordæ–¹æ³•
function exportWord(logId) {
  // å‚æ•°æ£€æŸ¥
  if (!logId) {
    wx.showToast({
      title: 'æ—¥å¿—IDä¸å­˜åœ¨',
      icon: 'none'
    })
    return
  }

  // æ˜¾ç¤ºåŠ è½½
  wx.showLoading({
    title: 'æ­£åœ¨å¯¼å‡º...',
    mask: true
  })

  // è·å–token
  const token = wx.getStorageSync(CONFIG.TOKEN_KEY)
  
  if (!token) {
    wx.hideLoading()
    wx.showToast({
      title: 'è¯·å…ˆç™»å½•',
      icon: 'none'
    })
    return
  }

  // æ„å»ºURL
  const url = `${CONFIG.BASE_URL}/api/supervision-logs/${logId}/export`
  
  console.log('å¯¼å‡ºURL:', url) // è°ƒè¯•ç”¨

  // ä¸‹è½½æ–‡ä»¶
  wx.downloadFile({
    url: url,
    header: {
      'Authorization': `Bearer ${token}`
    },
    success(res) {
      wx.hideLoading()
      console.log('ä¸‹è½½å“åº”:', res)
      
      if (res.statusCode === 200) {
        // æ‰“å¼€æ–‡æ¡£
        wx.openDocument({
          filePath: res.tempFilePath,
          fileType: 'docx',
          showMenu: true,
          success() {
            wx.showToast({
              title: 'å¯¼å‡ºæˆåŠŸ',
              icon: 'success'
            })
          },
          fail(err) {
            console.error('æ‰“å¼€å¤±è´¥:', err)
            wx.showToast({
              title: 'æ‰“å¼€å¤±è´¥',
              icon: 'none'
            })
          }
        })
      } else {
        // é”™è¯¯å¤„ç†
        let message = 'å¯¼å‡ºå¤±è´¥'
        if (res.statusCode === 401) {
          message = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'
        } else if (res.statusCode === 404) {
          message = 'æ—¥å¿—ä¸å­˜åœ¨'
        }
        wx.showToast({
          title: message,
          icon: 'none'
        })
      }
    },
    fail(err) {
      wx.hideLoading()
      console.error('ä¸‹è½½å¤±è´¥:', err)
      
      let message = 'ä¸‹è½½å¤±è´¥'
      if (err.errMsg && err.errMsg.includes('domain')) {
        message = 'è¯·é…ç½®downloadFileåˆæ³•åŸŸå'
      }
      
      wx.showToast({
        title: message,
        icon: 'none',
        duration: 3000
      })
    }
  })
}

// å¯¼å‡ºä¾›å…¶ä»–æ–‡ä»¶ä½¿ç”¨
module.exports = {
  exportWord
}
```

### åœ¨é¡µé¢ä¸­ä½¿ç”¨ï¼š

```javascript
// profile-logs.vue æˆ– profile-logs.js

const { exportWord } = require('../../utils/word-export') // è·¯å¾„æ ¹æ®å®é™…è°ƒæ•´

Page({
  data: {
    logId: null
  },

  onLoad(options) {
    this.setData({
      logId: options.id
    })
  },

  // å¯¼å‡ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
  handleExportWord() {
    exportWord(this.data.logId)
  }
})
```

---

## âœ… é…ç½®æ£€æŸ¥æ¸…å•

ä½¿ç”¨å‰è¯·é€é¡¹æ£€æŸ¥ï¼š

- [ ] å·²ä¿®æ”¹ `BASE_URL` ä¸ºå®é™…åç«¯åœ°å€
- [ ] åç«¯åœ°å€æ˜¯ `https://` å¼€å¤´ï¼ˆä¸èƒ½æ˜¯httpï¼‰
- [ ] å·²åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½® downloadFile åˆæ³•åŸŸå
- [ ] Token å­˜å‚¨çš„ key åç§°æ­£ç¡®ï¼ˆé»˜è®¤æ˜¯ 'token'ï¼‰
- [ ] æ¥å£è·¯å¾„æ­£ç¡®ï¼ˆ`/api/supervision-logs/:id/export`ï¼‰
- [ ] æ—¥å¿—IDå­˜åœ¨ä¸”æœ‰æ•ˆ
- [ ] åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
- [ ] ç½‘ç»œè¿æ¥æ­£å¸¸

---

## ğŸ†˜ ä»ç„¶å¤±è´¥ï¼Ÿ

### 1. åœ¨å¼€å‘å·¥å…·ä¸­æµ‹è¯•

å…ˆåœ¨å¼€å‘å·¥å…·ä¸­æµ‹è¯•ï¼Œå…³é—­åŸŸåæ ¡éªŒï¼š
- è¯¦æƒ… â†’ ä¸æ ¡éªŒåˆæ³•åŸŸå

å¦‚æœå¼€å‘å·¥å…·ä¸­èƒ½æˆåŠŸï¼š
âœ… è¯´æ˜ä»£ç æ­£ç¡®ï¼Œåªéœ€é…ç½®åŸŸåå³å¯

### 2. æŸ¥çœ‹å®Œæ•´é”™è¯¯ä¿¡æ¯

åœ¨ `fail` å›è°ƒä¸­æ·»åŠ ï¼š
```javascript
fail(err) {
  console.log('å®Œæ•´é”™è¯¯:', JSON.stringify(err))
  // å¤åˆ¶è¿™ä¸ªé”™è¯¯ä¿¡æ¯
}
```

### 3. æµ‹è¯•åç«¯æ¥å£

ä½¿ç”¨ curl æˆ– Postman æµ‹è¯•åç«¯ï¼š
```bash
curl -X GET \
  "https://your-domain.com/api/supervision-logs/1/export" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -o test.docx
```

å¦‚æœèƒ½ä¸‹è½½åˆ° `test.docx` æ–‡ä»¶ï¼Œè¯´æ˜åç«¯æ­£å¸¸ã€‚

### 4. è”ç³»æŠ€æœ¯æ”¯æŒ

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½ä¸è¡Œï¼Œè¯·æä¾›ï¼š
1. å®Œæ•´çš„é”™è¯¯ä¿¡æ¯
2. åç«¯åœ°å€ï¼ˆè„±æ•ï¼‰
3. æ¥å£è·¯å¾„
4. æ˜¯å¦é…ç½®äº†åŸŸå
5. åœ¨å¼€å‘å·¥å…·ä¸­æ˜¯å¦æˆåŠŸ

---

**æ›´æ–°æ—¶é—´**: 2024-11-07  
**é€‚ç”¨åœºæ™¯**: å¾®ä¿¡å°ç¨‹åº Word å¯¼å‡ºåŠŸèƒ½è°ƒè¯•

