# 方案3实施总结 - 使用 COS SDK 直接上传

## ✅ 已完成的工作

### 1. 路由文件切换
已将所有使用文件上传的路由文件切换到 COS SDK：

- ✅ `routes/upload.js` - 文件上传路由
- ✅ `routes/attachment.js` - 附件上传路由  
- ✅ `routes/v1/ai-chat.js` - AI聊天文件上传

**修改内容**：
```javascript
// 从
const { uploadFile, ... } = require('../utils/cloudStorage')
// 改为
const { uploadFile, ... } = require('../utils/cloudStorageCOS')
```

### 2. Bucket 名称提取逻辑修复
- ✅ 修复了从 CloudBase 域名中提取 Bucket 名称的逻辑
- ✅ Bucket 名称格式：`6a6c-jlzr1101-5g9kplxza13a780d-1302271970`

### 3. 测试脚本
- ✅ 创建了 `test-cos-upload.js` 测试脚本

## ⚠️ 当前问题

### 签名验证失败
测试时出现 `SignatureDoesNotMatch` 错误，说明：

1. **Secret ID/Key 可能没有 COS 权限**
   - 当前使用的密钥可能只有 CloudBase API 权限，没有 COS 直接访问权限

2. **需要使用 CloudBase 环境绑定的专用密钥**
   - CloudBase 环境的 COS Bucket 可能需要使用环境绑定的专用密钥

## 🔧 解决方案

### 方案A：添加 COS 权限（推荐）

**步骤**：
1. 登录腾讯云控制台：https://console.cloud.tencent.com/cam/capi
2. 找到您的 Secret ID: `AKIDOo36vZ4Riv3...`
3. 点击"授权"或"关联策略"
4. 添加以下权限策略之一：
   - **QcloudCOSFullAccess**（推荐）- COS 全读写权限
   - 或自定义策略包含以下操作：
     - `cos:PutObject` - 上传对象
     - `cos:GetObject` - 获取对象
     - `cos:DeleteObject` - 删除对象
     - `cos:HeadObject` - 获取对象元数据

5. 保存后等待权限生效（通常立即生效）
6. 重新运行测试：`node test-cos-upload.js`

### 方案B：使用 CloudBase 环境密钥

**步骤**：
1. 登录 CloudBase 控制台：https://console.cloud.tencent.com/tcb
2. 进入环境：`jlzr1101-5g9kplxza13a780d`
3. 进入"环境设置 > 安全配置"
4. 获取环境绑定的专用密钥
5. 在 `.env` 文件中替换：
   ```env
   TENCENTCLOUD_SECRET_ID=环境绑定的SecretID
   TENCENTCLOUD_SECRET_KEY=环境绑定的SecretKey
   ```
6. 重新运行测试：`node test-cos-upload.js`

### 方案C：使用 CloudBase 临时密钥（STS）

如果无法使用永久密钥，可以通过 CloudBase 获取临时密钥：

1. 使用 CloudBase SDK 获取临时密钥
2. 使用临时密钥初始化 COS SDK
3. 临时密钥包含 `SecretId`、`SecretKey`、`SessionToken`

**注意**：此方案需要修改 `utils/cloudStorageCOS.js` 以支持临时密钥。

## 📝 测试步骤

### 1. 检查权限配置
```bash
node test-permission-check.js
```

### 2. 测试 COS SDK 上传
```bash
node test-cos-upload.js
```

### 3. 如果测试成功
- ✅ 文件上传功能已切换到 COS SDK
- ✅ 可以正常使用所有文件上传接口
- ✅ 无需 CloudBase API 权限

### 4. 如果测试失败
根据错误信息：
- `SignatureDoesNotMatch` → 需要添加 COS 权限或使用环境密钥
- `AccessDenied` → 权限不足，需要添加权限
- `NoSuchBucket` → Bucket 不存在或名称错误

## 📋 相关文件

### 已修改的文件
- `routes/upload.js` - 使用 COS SDK
- `routes/attachment.js` - 使用 COS SDK
- `routes/v1/ai-chat.js` - 使用 COS SDK
- `utils/cloudStorageCOS.js` - COS SDK 实现（已修复 Bucket 名称提取）

### 测试文件
- `test-cos-upload.js` - COS SDK 上传测试
- `test-permission-check.js` - 权限检查工具

### 文档
- `docs/解决SIGN_PARAM_INVALID错误.md` - 完整解决方案
- `docs/文件上传问题解决方案总结.md` - 问题总结
- `docs/方案3实施总结.md` - 本文档

## 🎯 下一步操作

1. **立即操作**：
   - 根据上述方案A或B添加 COS 权限或获取环境密钥
   - 重新运行 `node test-cos-upload.js` 测试

2. **验证功能**：
   - 测试文件上传接口：`POST /api/upload`
   - 测试附件上传接口：`POST /api/attachments/upload`
   - 测试 AI 文件上传接口：`POST /api/v1/ai-chat/upload-file`

3. **如果仍有问题**：
   - 查看错误日志
   - 检查 Secret ID/Key 是否正确
   - 确认 Bucket 名称和区域配置是否正确
   - 联系腾讯云技术支持

## 💡 注意事项

1. **权限要求**：
   - COS SDK 需要 COS 权限，不是 CloudBase API 权限
   - 确保 Secret ID/Key 有正确的权限

2. **Bucket 名称**：
   - 已从域名中正确提取：`6a6c-jlzr1101-5g9kplxza13a780d-1302271970`
   - 如果域名格式变化，可能需要调整提取逻辑

3. **区域配置**：
   - 默认使用 `ap-shanghai`（上海区域）
   - 可通过环境变量 `COS_REGION` 配置

4. **回退方案**：
   - 如果 COS SDK 无法使用，可以切换回 CloudBase SDK
   - 只需将 `require('../utils/cloudStorageCOS')` 改回 `require('../utils/cloudStorage')`

---

**最后更新**：2024-11-06
**状态**：代码已切换，等待权限配置

