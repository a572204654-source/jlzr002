# 文件上传签名问题排查

## 问题描述

文件上传时出现签名验证错误：
```
signature calculated is different from client signature
```

## 问题分析

### 1. 环境变量配置 ✅ 已修复

**问题**：`.env` 文件中 `CLOUDBASE_ENV=production`，应该是实际的环境ID。

**解决方案**：
- 已修复 `.env` 文件，将 `CLOUDBASE_ENV` 设置为实际环境ID：`jlzr1101-5g9kplxza13a780d`
- 已在 `config/index.js` 中添加回退逻辑，如果 `CLOUDBASE_ENV` 为 `'production'`，则使用 `CLOUDBASE_ENV_ID`

### 2. 签名验证错误 ⚠️ 待解决

**错误位置**：在调用 `getUploadMetadata` API 时出现签名验证错误，说明问题出在 CloudBase API 调用阶段，而不是 COS 文件上传阶段。

**可能原因**：

1. **Secret ID/Key 权限问题**
   - 当前使用的 Secret ID/Key 可能没有 CloudBase 云存储的权限
   - 需要使用 CloudBase 环境对应的专用密钥

2. **密钥类型问题**
   - 可能需要使用 CloudBase 环境绑定的密钥，而不是通用的腾讯云 API 密钥
   - 或者需要使用临时密钥（STS）而不是永久密钥

3. **环境ID和密钥不匹配**
   - Secret ID/Key 可能不属于当前 CloudBase 环境
   - 需要确认密钥是否与 CloudBase 环境 `jlzr1101-5g9kplxza13a780d` 匹配

## 排查步骤

### 步骤1：检查 Secret ID/Key 权限

1. 登录腾讯云控制台：https://console.cloud.tencent.com/
2. 进入"访问管理 > API密钥管理"：https://console.cloud.tencent.com/cam/capi
3. 检查当前使用的 Secret ID（在 `.env` 文件中的 `TENCENTCLOUD_SECRET_ID`）是否有以下权限：
   - CloudBase（云开发）相关权限
   - 对象存储（COS）相关权限
   - 云存储相关权限

### 步骤2：检查 CloudBase 环境配置

1. 登录 CloudBase 控制台：https://console.cloud.tencent.com/tcb
2. 进入环境 `jlzr1101-5g9kplxza13a780d`
3. 检查"环境设置 > 安全配置"中的密钥配置
4. 确认是否需要使用环境绑定的专用密钥

### 步骤3：尝试使用临时密钥

如果永久密钥有问题，可以尝试使用临时密钥（STS）：

```javascript
const cloudbase = require('@cloudbase/node-sdk')

const app = cloudbase.init({
  env: envId,
  // 使用临时密钥
  secretId: tempSecretId,
  secretKey: tempSecretKey,
  sessionToken: sessionToken  // 临时密钥需要 sessionToken
})
```

### 步骤4：检查 SDK 版本

当前使用的 SDK 版本：`@cloudbase/node-sdk@^3.14.1`

可以尝试更新到最新版本：
```bash
npm update @cloudbase/node-sdk
```

### 步骤5：使用其他上传方式

如果 SDK 方式有问题，可以考虑：

1. **直接使用 COS SDK**
   - 使用 `cos-nodejs-sdk-v5` 直接上传到 COS
   - 需要从 CloudBase 获取 COS 的临时密钥

2. **使用 HTTP API**
   - 直接调用 CloudBase HTTP API
   - 需要手动计算签名

## 当前配置状态

✅ **已正确配置**：
- `CLOUDBASE_ENV`: `jlzr1101-5g9kplxza13a780d`
- `TENCENTCLOUD_SECRET_ID`: 已设置
- `TENCENTCLOUD_SECRET_KEY`: 已设置
- CloudBase SDK 初始化：成功

❌ **待解决**：
- CloudBase API 调用签名验证失败
- 需要确认 Secret ID/Key 是否有 CloudBase 权限

## 建议的解决方案

### 方案1：检查并添加权限（推荐）

1. 在腾讯云控制台检查 Secret ID 的权限
2. 确保有 CloudBase 和 COS 的完整权限
3. 如果权限不足，添加相应权限

### 方案2：使用 CloudBase 环境密钥

1. 在 CloudBase 控制台获取环境绑定的密钥
2. 使用环境密钥替换当前的通用密钥

### 方案3：使用临时密钥

1. 通过 STS 服务获取临时密钥
2. 使用临时密钥进行文件上传

### 方案4：直接使用 COS SDK

1. 从 CloudBase 获取 COS 临时密钥
2. 使用 `cos-nodejs-sdk-v5` 直接上传到 COS

## 相关链接

- CloudBase 官方文档：https://cloud.tencent.com/document/product/876
- CloudBase Node.js SDK：https://cloud.tencent.com/document/product/876/18442
- 签名验证错误排查：https://tcb.cloud.tencent.com/dev#/helper/copilot?q=SIGN_PARAM_INVALID

## 测试命令

```bash
# 测试配置
node test-cloud-config.js

# 测试上传（详细诊断）
node test-upload-debug.js

# 测试完整上传流程
node test-upload-ai.js
```

