# 云托管环境变量配置说明

## 测试结果

✅ **已成功测试的功能：**
- 登录认证：正常
- AI会话创建：正常
- 豆包AI对话：正常返回数据

❌ **需要配置的功能：**
- 文件上传：需要配置 `CLOUDBASE_ENV_ID` 环境变量

## 需要在云托管环境中配置的环境变量

### 必需的环境变量

在腾讯云 CloudBase 云托管控制台中，需要添加以下环境变量：

```bash
# CloudBase 环境ID（云托管自动注入，通常无需手动配置）
CLOUDBASE_ENV=your-cloudbase-env-id

# 腾讯云API密钥（必需，用于云存储）
TENCENTCLOUD_SECRET_ID=YOUR_SECRET_ID
TENCENTCLOUD_SECRET_KEY=YOUR_SECRET_KEY

# 豆包AI配置（可选，AI功能需要）
DOUBAO_API_KEY=your-doubao-api-key
DOUBAO_ENDPOINT_ID=your-doubao-endpoint-id
DOUBAO_API_URL=https://ark.cn-beijing.volces.com/api/v3
```

## 配置步骤

### 1. 登录腾讯云控制台

访问 [腾讯云 CloudBase 控制台](https://console.cloud.tencent.com/tcb)

### 2. 进入云托管服务

1. 选择你的环境
2. 进入 **云托管** 服务
3. 找到你的服务（service: `express`）

### 3. 配置环境变量

1. 进入服务的 **配置管理** 或 **环境变量** 页面
2. 添加以下环境变量：

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `CLOUDBASE_ENV` | `your-cloudbase-env-id` | CloudBase环境ID（云托管自动注入，通常无需手动配置） |
| `TENCENTCLOUD_SECRET_ID` | `YOUR_SECRET_ID` | 腾讯云API密钥ID（必需） |
| `TENCENTCLOUD_SECRET_KEY` | `YOUR_SECRET_KEY` | 腾讯云API密钥Key（必需） |
| `DOUBAO_API_KEY` | `your-doubao-api-key` | 豆包API密钥（可选，AI功能需要） |
| `DOUBAO_ENDPOINT_ID` | `your-doubao-endpoint-id` | 豆包推理接入点ID（可选，AI功能需要） |

### 4. 重启服务

配置完成后，需要重启云托管服务使环境变量生效。

## 验证配置

配置完成后，可以使用以下命令测试：

```bash
node test-upload-ai.js
```

或者使用 curl 测试：

```bash
# 1. 登录获取token
curl -X POST https://api.yimengpl.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"code":"test_wechat_code_test"}'

# 2. 创建会话（替换 {token} 为实际token）
curl -X POST https://api.yimengpl.com/api/v1/ai-chat/session \
  -H "Authorization: Bearer {token}"

# 3. 上传文件（替换 {token} 和 {sessionId}）
curl -X POST https://api.yimengpl.com/api/v1/ai-chat/upload-file \
  -H "Authorization: Bearer {token}" \
  -F "file=@C:\Users\admin\Desktop\后端 - 副本\docs\导出格式.doc" \
  -F "sessionId={sessionId}" \
  -F "message=请分析这个文件"
```

## 测试结果说明

### ✅ 已成功测试

1. **登录功能**：使用测试code `test_wechat_code_upload_test` 成功登录
2. **AI会话创建**：成功创建会话ID
3. **豆包AI对话**：成功调用豆包API并返回数据
   - 测试消息："你好，请介绍一下你自己"
   - AI回复：正常返回，说明豆包API配置正确

### ❌ 待配置

1. **文件上传功能**：需要配置云存储相关环境变量
   - 错误信息：`云存储配置不完整，请检查环境变量 CLOUDBASE_ENV、TENCENTCLOUD_SECRET_ID、TENCENTCLOUD_SECRET_KEY`
   - 解决方案：在云托管环境中添加 `TENCENTCLOUD_SECRET_ID` 和 `TENCENTCLOUD_SECRET_KEY`（`CLOUDBASE_ENV` 由云托管自动注入）

## 注意事项

1. **环境变量优先级**：云托管环境中的环境变量会覆盖代码中的默认值
2. **安全性**：确保敏感信息（如API密钥）不要提交到代码仓库
3. **重启服务**：修改环境变量后必须重启服务才能生效
4. **测试环境**：本地测试连接的是云托管环境，所以需要在云托管中配置环境变量

## 相关文件

- 测试脚本：`test-upload-ai.js`
- 配置文件：`.env`（本地开发环境）
- 云存储工具：`utils/cloudStorage.js`
- 豆包AI工具：`utils/doubao.js`

