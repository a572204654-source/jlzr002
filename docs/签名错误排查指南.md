# 腾讯云 API 签名错误排查指南

## 错误信息

```
The provided credentials could not be validated. Please check your signature is correct.
```

## 常见原因

### 1. SecretKey 错误

**症状**: 签名验证失败，返回 401 错误

**排查步骤**:
1. 检查环境变量 `TENCENTCLOUD_SECRET_KEY` 是否正确配置
2. 确认 SecretKey 没有多余的空格、换行符或引号
3. 在腾讯云控制台重新生成密钥对
4. 确认 SecretKey 长度（通常为 40 个字符）

**解决方案**:
```bash
# 检查环境变量
echo $TENCENTCLOUD_SECRET_KEY

# 或在 .env 文件中检查
cat .env | grep TENCENTCLOUD_SECRET_KEY

# 运行诊断工具
npm run diagnose-signature
```

### 2. 时区问题

**症状**: 签名在特定时间段失败，或在不同时区服务器上失败

**排查步骤**:
1. 检查系统时区设置
2. 确认代码使用 UTC 时区生成时间戳
3. 检查时间戳是否在有效范围内（通常 5 分钟内）

**解决方案**:
- 代码已修复，统一使用 UTC 时区
- 如果仍有问题，检查系统时间是否准确：
```bash
# Linux/Mac
date -u

# Windows PowerShell
Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC"
```

### 3. 网络代理问题

**症状**: 在代理环境下签名验证失败

**排查步骤**:
1. 检查是否设置了 HTTP_PROXY 或 HTTPS_PROXY
2. 确认代理不会修改请求头
3. 尝试禁用代理测试

**解决方案**:
```bash
# 临时禁用代理
unset HTTP_PROXY
unset HTTPS_PROXY

# 或在代码中配置代理（已支持）
# 设置环境变量：
export HTTPS_PROXY=http://proxy.example.com:8080
```

如果需要使用代理，安装代理包：
```bash
npm install https-proxy-agent http-proxy-agent
```

### 4. 其他可能原因

**SecretId 和 SecretKey 不匹配**:
- 确认使用的是同一账户的密钥对
- 检查是否混用了不同账户的密钥

**权限问题**:
- 确认账户有语音识别服务的权限
- 检查 API 密钥是否被禁用

**API 调用频率超限**:
- 检查是否超过调用频率限制
- 查看腾讯云控制台的调用统计

## 诊断工具

运行诊断工具检查配置：

```bash
npm run diagnose-signature
```

诊断工具会检查：
1. ✅ 环境变量配置
2. ✅ SecretKey 格式和长度
3. ✅ 时区设置
4. ✅ 签名生成测试
5. ✅ 代理配置

## 代码修复说明

### 已修复的问题

1. **UTC 时区支持**
   - 新增 `getUTCTimestamp()` 方法，确保使用 UTC 时间戳
   - 新增 `getUTCDateString()` 方法，使用 UTC 方法获取日期字符串
   - 所有签名生成统一使用 UTC 时区

2. **SecretKey 验证**
   - 在构造函数中验证 SecretKey 是否存在
   - 检查 SecretKey 长度，给出警告提示

3. **代理支持**
   - 支持通过环境变量配置 HTTP/HTTPS 代理
   - 自动检测并使用代理（如果配置了）
   - 代理功能为可选，不影响正常使用

### 代码变更

```javascript
// 修复前
const timestamp = Math.floor(Date.now() / 1000)
const date = new Date(timestamp * 1000).toISOString().split('T')[0]

// 修复后
const timestamp = this.getUTCTimestamp()  // 确保 UTC 时区
const date = this.getUTCDateString(timestamp)  // 使用 UTC 方法
```

## 测试验证

### 1. 测试签名生成

```bash
# 运行诊断工具
npm run diagnose-signature

# 运行语音识别测试
npm run test-voice
```

### 2. 检查日志

查看控制台输出，确认：
- ✅ 签名生成成功
- ✅ 使用 UTC 时区
- ✅ 代理配置正确（如果使用）

### 3. 实际 API 调用测试

```javascript
const { getVoiceRecognitionService } = require('./utils/voiceRecognition')

const service = getVoiceRecognitionService()

// 测试一句话识别
const audioData = Buffer.from('test audio data')
try {
  const result = await service.recognizeFile(audioData)
  console.log('识别成功:', result)
} catch (error) {
  console.error('识别失败:', error.message)
}
```

## 常见问题 FAQ

### Q1: 为什么修复后仍然报错？

**A**: 可能的原因：
1. 环境变量未重新加载，需要重启服务
2. SecretKey 确实错误，需要重新生成
3. 网络问题，检查防火墙和代理设置

### Q2: 如何确认使用的是 UTC 时区？

**A**: 运行诊断工具，查看时区检查部分：
```bash
npm run diagnose-signature
```

### Q3: 代理环境下如何配置？

**A**: 设置环境变量：
```bash
export HTTPS_PROXY=http://proxy.example.com:8080
export HTTP_PROXY=http://proxy.example.com:8080
```

如果需要认证：
```bash
export HTTPS_PROXY=http://username:password@proxy.example.com:8080
```

### Q4: SecretKey 长度应该是多少？

**A**: 腾讯云 SecretKey 通常为 40 个字符。如果长度不对，可能是：
- 复制时包含了空格或换行
- 使用了错误的密钥
- 密钥格式异常

## 联系支持

如果以上方法都无法解决问题：

1. 运行诊断工具并保存输出
2. 检查腾讯云控制台的 API 调用日志
3. 联系腾讯云技术支持，提供：
   - 诊断工具输出
   - 错误时间戳
   - SecretId（前8位）
   - 错误详情

---

**最后更新**: 2024-11-06
**相关文件**: 
- `utils/voiceRecognition.js` - 语音识别服务
- `test/diagnose-signature-issue.js` - 诊断工具


