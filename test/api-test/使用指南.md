# APIæµ‹è¯•å·¥å…·ä½¿ç”¨æŒ‡å—

## ğŸ“¦ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
cd test/api-test
npm install
```

### 2. ç¡®ä¿æœåŠ¡è¿è¡Œ

åœ¨é¡¹ç›®æ ¹ç›®å½•å¯åŠ¨æœåŠ¡ï¼š

```bash
cd ../../
npm start
```

### 3. è¿è¡Œæµ‹è¯•

```bash
# è¿”å›test/api-testç›®å½•
cd test/api-test

# è¿è¡Œå…¨éƒ¨æµ‹è¯•
npm test
```

---

## ğŸ¯ æµ‹è¯•å‘½ä»¤

### è¿è¡Œå…¨éƒ¨æµ‹è¯•

```bash
npm test
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
============================================================
  ç›‘ç†æ—¥å¿—å°ç¨‹åº Cç«¯API æ¥å£æµ‹è¯•
============================================================

â–º è®¤è¯APIæµ‹è¯•
------------------------------------------------------------
  âœ“ æµ‹è¯•ç™»å½•
  âœ“ é€€å‡ºç™»å½•

â–º ç”¨æˆ·APIæµ‹è¯•
------------------------------------------------------------
  âœ“ è·å–ç”¨æˆ·ä¿¡æ¯
  âœ“ æ›´æ–°ç”¨æˆ·ä¿¡æ¯
  ...

============================================================
  æµ‹è¯•å®Œæˆ
============================================================
  æ€»è®¡: 28
  é€šè¿‡: 21
  å¤±è´¥: 7
  è€—æ—¶: 32.17s
============================================================
```

### è¿è¡Œå•ä¸ªæ¨¡å—æµ‹è¯•

```bash
# è®¤è¯æµ‹è¯•
npm run test:auth

# ç”¨æˆ·æµ‹è¯•
npm run test:user

# é¡¹ç›®ç®¡ç†æµ‹è¯•
npm run test:project

# å·¥ç¨‹ç®¡ç†æµ‹è¯•
npm run test:work

# ç›‘ç†æ—¥å¿—æµ‹è¯•
npm run test:log

# é™„ä»¶ç®¡ç†æµ‹è¯•
npm run test:attachment

# AIå¯¹è¯æµ‹è¯•
npm run test:ai

# å¤©æ°”æŸ¥è¯¢æµ‹è¯•
npm run test:weather
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### é…ç½®æ–‡ä»¶ï¼š`config.js`

```javascript
module.exports = {
  // æµ‹è¯•ç¯å¢ƒAPIåœ°å€
  baseURL: 'http://localhost:80',
  
  // è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  timeout: 10000,
  
  // æµ‹è¯•è´¦å·openid
  testOpenid: 'test_openid_001'
}
```

### ä¿®æ”¹æµ‹è¯•ç¯å¢ƒ

å¦‚æœAPIæœåŠ¡è¿è¡Œåœ¨å…¶ä»–åœ°å€æˆ–ç«¯å£ï¼š

```javascript
baseURL: 'http://localhost:3000'  // ä¿®æ”¹ä¸ºå®é™…åœ°å€
```

### ä¿®æ”¹è¶…æ—¶æ—¶é—´

å¦‚æœç½‘ç»œè¾ƒæ…¢æˆ–AIæ¥å£å“åº”æ…¢ï¼š

```javascript
timeout: 30000  // å¢åŠ åˆ°30ç§’
```

### ä½¿ç”¨ä¸åŒæµ‹è¯•è´¦å·

æ•°æ®åº“ä¸­æœ‰3ä¸ªæµ‹è¯•ç”¨æˆ·å¯é€‰ï¼š

```javascript
testOpenid: 'test_openid_001'  // å¼ ä¸‰
// testOpenid: 'test_openid_002'  // æå››
// testOpenid: 'test_openid_003'  // ç‹äº”
```

---

## ğŸ“Š æµ‹è¯•ç»“æœè§£è¯»

### æˆåŠŸæ ‡è®°

```
âœ“ æµ‹è¯•åç§°
  è¿”å›: {ç›¸å…³æ•°æ®}
  â„¹ é™„åŠ ä¿¡æ¯
```

- **âœ“** : æµ‹è¯•é€šè¿‡
- **è¿”å›**: æ¥å£è¿”å›çš„å…³é”®æ•°æ®
- **â„¹** : é¢å¤–çš„æç¤ºä¿¡æ¯ï¼ˆå¦‚ä¿å­˜çš„IDï¼‰

### å¤±è´¥æ ‡è®°

```
âœ— æµ‹è¯•åç§°
  é”™è¯¯: é”™è¯¯ä¿¡æ¯
```

- **âœ—** : æµ‹è¯•å¤±è´¥
- **é”™è¯¯**: å…·ä½“çš„é”™è¯¯æè¿°

### ç»Ÿè®¡ä¿¡æ¯

```
============================================================
  æµ‹è¯•å®Œæˆ
============================================================
  æ€»è®¡: 28      # æ€»æµ‹è¯•æ•°
  é€šè¿‡: 21      # æˆåŠŸæ•°é‡
  å¤±è´¥: 7       # å¤±è´¥æ•°é‡
  è€—æ—¶: 32.17s  # æ€»è€—æ—¶
============================================================
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: è¿æ¥å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

```
é”™è¯¯: connect ECONNREFUSED 127.0.0.1:80
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤æœåŠ¡å·²å¯åŠ¨ï¼š`npm start`ï¼ˆåœ¨é¡¹ç›®æ ¹ç›®å½•ï¼‰
2. æ£€æŸ¥ç«¯å£æ˜¯å¦æ­£ç¡®ï¼ˆé»˜è®¤80ï¼‰
3. ç¡®è®¤é˜²ç«å¢™æ²¡æœ‰é˜»æ­¢è¿æ¥

### Q2: Tokenæ— æ•ˆï¼Ÿ

```
é”™è¯¯: è¯·æä¾›è®¤è¯Token
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å¿…é¡»è¿è¡Œå®Œæ•´æµ‹è¯•ï¼ˆåŒ…å«ç™»å½•æ­¥éª¤ï¼‰
2. ä¸è¦å•ç‹¬è¿è¡Œéœ€è¦è®¤è¯çš„æµ‹è¯•
3. ç¡®è®¤JWTé…ç½®æ­£ç¡®

### Q3: è¶…æ—¶é”™è¯¯ï¼Ÿ

```
é”™è¯¯: timeout of 10000ms exceeded
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆä¿®æ”¹ `config.js` ä¸­çš„ `timeout`ï¼‰
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. æ£€æŸ¥æœåŠ¡æ€§èƒ½ï¼ˆAIæ¥å£å¯èƒ½è¾ƒæ…¢ï¼‰

### Q4: æ•°æ®åº“é”™è¯¯ï¼Ÿ

```
é”™è¯¯: Unknown column 'xxx' in 'field list'
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. é‡æ–°åˆå§‹åŒ–æ•°æ®åº“ï¼š`node scripts/init-db.js`
2. å¯¼å…¥æµ‹è¯•æ•°æ®ï¼š`node scripts/init-db-data.js`
3. æ£€æŸ¥æ•°æ®åº“é…ç½®

### Q5: åˆ—è¡¨æ¥å£å¤±è´¥ï¼Ÿ

```
é”™è¯¯: è·å–XXåˆ—è¡¨å¤±è´¥
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æŸ¥çœ‹æœåŠ¡ç«¯æ—¥å¿—ï¼Œæ‰¾åˆ°å…·ä½“é”™è¯¯
2. æ£€æŸ¥æ•°æ®åº“æŸ¥è¯¢è¯­å¥
3. ç¡®è®¤è¯·æ±‚å‚æ•°æ ¼å¼æ­£ç¡®

---

## ğŸ› ï¸ è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹è¯¦ç»†è¯·æ±‚

ä¿®æ”¹ `utils/request.js`ï¼Œåœ¨è¯·æ±‚æ‹¦æˆªå™¨ä¸­æ·»åŠ æ—¥å¿—ï¼š

```javascript
request.interceptors.request.use(
  config => {
    console.log('è¯·æ±‚:', config.method.toUpperCase(), config.url)
    console.log('å‚æ•°:', config.data || config.params)
    // ...
  }
)
```

### 2. æŸ¥çœ‹å®Œæ•´å“åº”

ä¿®æ”¹æµ‹è¯•æ–‡ä»¶ï¼Œè¾“å‡ºå®Œæ•´å“åº”ï¼š

```javascript
const response = await request({...})
console.log('å®Œæ•´å“åº”:', JSON.stringify(response, null, 2))
```

### 3. å•æ­¥è°ƒè¯•

åœ¨éœ€è¦è°ƒè¯•çš„æµ‹è¯•å‡½æ•°ä¸­æ·»åŠ æ–­ç‚¹ï¼Œä½¿ç”¨ Node.js è°ƒè¯•å™¨ï¼š

```bash
node --inspect-brk tests/project.test.js
```

ç„¶ååœ¨Chromeä¸­æ‰“å¼€ `chrome://inspect` è¿›è¡Œè°ƒè¯•ã€‚

### 4. è·³è¿‡æŸäº›æµ‹è¯•

åœ¨æµ‹è¯•å‡½æ•°ä¸­æ·»åŠ  `return` è·³è¿‡ï¼š

```javascript
async function testGetProjects() {
  return  // è·³è¿‡æ­¤æµ‹è¯•
  // ...æµ‹è¯•ä»£ç 
}
```

---

## ğŸ“ è‡ªå®šä¹‰æµ‹è¯•

### æ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹

1. åœ¨ `tests/` ç›®å½•åˆ›å»ºæ–°æ–‡ä»¶ï¼Œå¦‚ `custom.test.js`ï¼š

```javascript
const request = require('../utils/request')
const logger = require('../utils/logger')

async function runCustomTests() {
  logger.startModule('è‡ªå®šä¹‰æµ‹è¯•')
  
  // æ·»åŠ æµ‹è¯•
  await testMyApi()
}

async function testMyApi() {
  try {
    const response = await request({
      url: '/api/my-endpoint',
      method: 'GET',
      needAuth: true
    })
    
    if (response.code !== 0) {
      throw new Error(`å“åº”ç é”™è¯¯: ${response.code}`)
    }
    
    logger.success('æµ‹è¯•æˆåŠŸ', response.data)
  } catch (error) {
    logger.fail('æµ‹è¯•å¤±è´¥', error)
  }
}

module.exports = { runCustomTests }
```

2. åœ¨ `index.js` ä¸­å¼•å…¥å¹¶è°ƒç”¨ï¼š

```javascript
const { runCustomTests } = require('./tests/custom.test')

// åœ¨runAllTestså‡½æ•°ä¸­æ·»åŠ 
await runCustomTests()
```

3. æ·»åŠ å¿«æ·å‘½ä»¤åˆ° `package.json`ï¼š

```json
{
  "scripts": {
    "test:custom": "node tests/custom.test.js"
  }
}
```

---

## ğŸ“š é¡¹ç›®ç»“æ„

```
test/api-test/
â”œâ”€â”€ tests/                 # æµ‹è¯•ç”¨ä¾‹
â”‚   â”œâ”€â”€ auth.test.js      # è®¤è¯
â”‚   â”œâ”€â”€ user.test.js      # ç”¨æˆ·
â”‚   â”œâ”€â”€ project.test.js   # é¡¹ç›®
â”‚   â”œâ”€â”€ work.test.js      # å·¥ç¨‹
â”‚   â”œâ”€â”€ supervision-log.test.js  # æ—¥å¿—
â”‚   â”œâ”€â”€ attachment.test.js       # é™„ä»¶
â”‚   â”œâ”€â”€ ai-chat.test.js         # AIå¯¹è¯
â”‚   â””â”€â”€ weather.test.js         # å¤©æ°”
â”œâ”€â”€ utils/                # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ request.js       # HTTPè¯·æ±‚
â”‚   â””â”€â”€ logger.js        # æ—¥å¿—è¾“å‡º
â”œâ”€â”€ config.js            # é…ç½®
â”œâ”€â”€ index.js             # ä¸»å…¥å£
â”œâ”€â”€ package.json         # ä¾èµ–
â”œâ”€â”€ README.md            # è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ TEST_REPORT.md       # æµ‹è¯•æŠ¥å‘Š
â””â”€â”€ ä½¿ç”¨æŒ‡å—.md          # æœ¬æ–‡æ¡£
```

---

## ğŸ¨ è¾“å‡ºé¢œè‰²è¯´æ˜

- **ç»¿è‰² âœ“** : æµ‹è¯•é€šè¿‡
- **çº¢è‰² âœ—** : æµ‹è¯•å¤±è´¥
- **è“è‰² â„¹** : æç¤ºä¿¡æ¯
- **é»„è‰² âš ** : è­¦å‘Šä¿¡æ¯
- **é’è‰²æ ‡é¢˜** : æ¨¡å—åˆ†éš”

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æµ‹è¯•å‰å‡†å¤‡

- âœ… ç¡®ä¿æ•°æ®åº“å·²åˆå§‹åŒ–
- âœ… ç¡®ä¿æœåŠ¡æ­£å¸¸è¿è¡Œ
- âœ… æ¸…ç†ä¹‹å‰çš„æµ‹è¯•æ•°æ®ï¼ˆå¯é€‰ï¼‰

### 2. æµ‹è¯•é¡ºåº

- å¿…é¡»å…ˆè¿è¡Œè®¤è¯æµ‹è¯•ï¼ˆè·å–Tokenï¼‰
- æŒ‰ç…§ä¾èµ–å…³ç³»è¿è¡Œï¼ˆé¡¹ç›®â†’å·¥ç¨‹â†’æ—¥å¿—â†’é™„ä»¶ï¼‰
- å®Œæ•´æµ‹è¯•ä¼˜äºå•æ¨¡å—æµ‹è¯•

### 3. æµ‹è¯•æ•°æ®

- ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•è´¦å·
- æµ‹è¯•æ•°æ®ä½¿ç”¨æ˜æ˜¾çš„æ ‡è¯†ï¼ˆå¦‚æ—¶é—´æˆ³ï¼‰
- æµ‹è¯•åå¯æ‰‹åŠ¨æ¸…ç†æ•°æ®

### 4. æŒç»­é›†æˆ

å¯å°†æµ‹è¯•é›†æˆåˆ°CI/CDæµç¨‹ï¼š

```yaml
# .github/workflows/test.yml
name: API Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v2
      - name: Install
        run: |
          npm install
          cd test/api-test && npm install
      - name: Test
        run: |
          npm start &
          sleep 5
          cd test/api-test && npm test
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Šï¼š`TEST_REPORT.md`
- æŸ¥çœ‹APIæ–‡æ¡£ï¼š`../../docx/c-api/`
- æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£ï¼š`../../PROJECT_SUMMARY.md`

---

**ç¥æµ‹è¯•æ„‰å¿«ï¼** ğŸš€

