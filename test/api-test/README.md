# 监理日志小程序 C端API 接口测试

## 简介

这是监理日志小程序C端API的自动化测试脚本，严格按照 `docx/c-api/` 目录下的API文档编写。

## 测试范围

- ✅ 认证API（2个接口）
- ✅ 用户API（4个接口）
- ✅ 项目管理API（5个接口）
- ✅ 工程管理API（5个接口）
- ✅ 监理日志API（6个接口）
- ✅ 附件管理API（5个接口）
- ✅ AI对话API（5个接口）
- ✅ 天气查询API（2个接口）

**总计：34个接口**

## 快速开始

### 1. 安装依赖

```bash
cd test/api-test
npm install
```

### 2. 确保服务已启动

在项目根目录启动服务：

```bash
npm start
```

服务应该运行在 `http://localhost:80`

### 3. 运行测试

#### 运行所有测试

```bash
npm test
```

#### 运行单个模块测试

```bash
# 认证测试
npm run test:auth

# 用户测试
npm run test:user

# 项目管理测试
npm run test:project

# 工程管理测试
npm run test:work

# 监理日志测试
npm run test:log

# 附件管理测试
npm run test:attachment

# AI对话测试
npm run test:ai

# 天气查询测试
npm run test:weather
```

## 测试流程

测试按照依赖顺序自动执行：

```
1. 认证测试
   ↓ (获取Token)
2. 用户测试
   ↓
3. 项目管理测试
   ↓ (创建测试项目)
4. 工程管理测试
   ↓ (创建测试工程)
5. 监理日志测试
   ↓ (创建测试日志)
6. 附件管理测试
   ↓
7. AI对话测试
   ↓
8. 天气查询测试
```

## 配置说明

配置文件：`config.js`

```javascript
module.exports = {
  // 测试环境API地址
  baseURL: 'http://localhost:80',
  
  // 超时时间
  timeout: 10000,
  
  // 测试账号（使用开发模式的test code）
  testCode: 'test_wechat_code_123'
}
```

如果需要修改测试环境地址，请修改 `baseURL`。

## 测试特点

### 1. 严格按照文档

- 所有接口路径、请求参数、响应字段都严格按照API文档编写
- 字段命名使用驼峰命名法（camelCase）
- 响应格式验证完整

### 2. 自动化依赖管理

- 自动保存创建的资源ID（项目、工程、日志等）
- 后续测试自动使用前面创建的资源
- Token自动管理和传递

### 3. 友好的输出

- 彩色输出，清晰易读
- 成功/失败状态一目了然
- 详细的错误信息
- 测试统计汇总

### 4. 模块化设计

- 每个API模块独立测试文件
- 可单独运行某个模块的测试
- 易于维护和扩展

## 测试结果示例

```
============================================================
  监理日志小程序 C端API 接口测试
============================================================

► 认证API测试
------------------------------------------------------------
  ✓ 微信登录
    返回: {"token":"eyJhbGc...","userId":1,"nickname":"张三"}
    ℹ Token已保存，用户ID: 1
  ✓ 退出登录
    返回: {"message":"退出成功"}

► 用户API测试
------------------------------------------------------------
  ✓ 获取用户信息
  ✓ 更新用户信息
  ✓ 获取用户项目列表
  ✓ 获取用户日志统计

...

============================================================
  测试完成
============================================================
  总计: 34
  通过: 34
  失败: 0
  耗时: 5.23s
============================================================
```

## 项目结构

```
test/api-test/
├── tests/                  # 测试用例目录
│   ├── auth.test.js       # 认证API测试
│   ├── user.test.js       # 用户API测试
│   ├── project.test.js    # 项目管理API测试
│   ├── work.test.js       # 工程管理API测试
│   ├── supervision-log.test.js  # 监理日志API测试
│   ├── attachment.test.js # 附件管理API测试
│   ├── ai-chat.test.js    # AI对话API测试
│   └── weather.test.js    # 天气查询API测试
├── utils/                  # 工具函数
│   ├── request.js         # HTTP请求工具
│   └── logger.js          # 日志输出工具
├── config.js              # 配置文件
├── index.js               # 测试主入口
├── package.json           # 依赖配置
└── README.md              # 说明文档
```

## 注意事项

### 1. 测试环境

- 确保测试环境数据库已初始化
- 确保服务正常运行
- 建议使用独立的测试数据库

### 2. 测试数据

- 测试会创建实际数据（项目、工程、日志等）
- 部分删除操作已注释，避免影响后续测试
- 可在测试完成后手动清理测试数据

### 3. 开发模式

- 使用 `test_wechat_code_` 开头的code进行测试
- 开发模式会自动创建/查找测试用户
- 生产环境需使用真实的微信code

### 4. 网络和超时

- 默认超时时间10秒
- AI对话测试可能需要较长时间
- 如遇超时，可增加 `config.js` 中的 `timeout` 值

## 故障排查

### 问题1：连接失败

```
错误: connect ECONNREFUSED 127.0.0.1:80
```

**解决方法**：
- 确认服务已启动：`npm start`
- 检查端口是否正确（默认80）
- 修改 `config.js` 中的 `baseURL`

### 问题2：Token无效

```
错误: 响应码错误: 401
```

**解决方法**：
- 重新运行完整测试（包含认证测试）
- 确认JWT_SECRET配置正确
- 检查Token是否过期

### 问题3：数据库错误

```
错误: 项目不存在
```

**解决方法**：
- 运行完整测试（不要单独运行依赖其他模块的测试）
- 检查数据库连接
- 重新初始化数据库

## 扩展开发

### 添加新的测试用例

1. 在 `tests/` 目录创建新的测试文件
2. 按照现有格式编写测试函数
3. 在 `index.js` 中引入并调用
4. 更新 `package.json` 添加快捷命令

### 修改测试配置

编辑 `config.js` 文件，可修改：
- API基础地址
- 超时时间
- 测试账号

## 依赖说明

- **axios**: HTTP请求库
- **colors**: 终端彩色输出

## 版本信息

- 版本: 1.0.0
- 更新日期: 2024-11-07
- Node.js要求: >= 14.0.0

## 技术支持

如有问题，请参考：
- API文档：`docx/c-api/`
- 项目文档：`PROJECT_SUMMARY.md`
- 快速开始：`QUICK_START.md`

---

**祝测试顺利！** ✨

