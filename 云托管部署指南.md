# 云托管部署指南

## 📋 部署前准备

### 1. 检查必需文件
确保以下文件存在且正确配置：
- ✅ `Dockerfile` - Docker 镜像构建配置
- ✅ `.dockerignore` - 排除不必要的文件
- ✅ `package.json` - 项目依赖配置
- ✅ `.env` - 环境变量（本地测试用，不会上传）

### 2. 环境变量配置
在云托管控制台配置以下环境变量：

#### 必需配置
```bash
# 数据库配置（使用内网地址）
DB_HOST=your-mysql-internal-host
DB_PORT=3306
DB_USER=your-db-username
DB_PASSWORD=your-db-password
DB_NAME=your-database-name

# 微信小程序配置
WECHAT_APPID=your-miniapp-appid
WECHAT_APPSECRET=your-miniapp-secret

# JWT 配置
JWT_SECRET=your-strong-secret-key
JWT_EXPIRES_IN=7d

# 和风天气配置
QWEATHER_KEY=your-qweather-api-key
QWEATHER_PUBLIC_ID=your-public-id
QWEATHER_PROJECT_ID=your-project-id
QWEATHER_PRIVATE_KEY=your-ed25519-private-key
```

#### 可选配置
```bash
# 应用配置
NODE_ENV=production
PORT=80

# 日志级别
LOG_LEVEL=info
```

## 🚀 部署步骤

### 步骤 1：提交代码到 Git 仓库
```bash
# 添加所有修改
git add .

# 提交代码
git commit -m "优化: 更新 Dockerfile 配置"

# 推送到远程仓库
git push origin main
```

### 步骤 2：在云托管控制台触发部署

1. 登录微信云托管控制台
2. 选择你的服务
3. 点击"新建版本"
4. 选择代码来源（GitHub 或其他）
5. 选择分支：`main`
6. 等待构建完成

### 步骤 3：配置环境变量

在云托管控制台：
1. 进入"版本管理"
2. 选择"环境变量"
3. 添加上述所有必需的环境变量
4. 保存配置

### 步骤 4：配置服务访问

1. **端口配置**：确保监听端口设置为 `80`
2. **健康检查**：路径设置为 `/health`
3. **域名绑定**：在"服务配置"中绑定自定义域名

### 步骤 5：初始化数据库

部署成功后，使用以下接口初始化数据库：

```bash
# 初始化数据库表结构（首次部署时调用）
curl -X POST https://your-domain.com/api/setup/init-db

# 初始化测试数据（可选）
curl -X POST https://your-domain.com/api/setup/init-data
```

## ✅ 部署验证

### 1. 健康检查
```bash
curl https://your-domain.com/health
```

**期望返回**：
```json
{
  "status": "healthy",
  "timestamp": 1699200000000
}
```

### 2. API 测试
```bash
# 测试天气接口（不需要登录）
curl "https://your-domain.com/api/weather/v1/now?location=101010100"
```

### 3. 数据库连接测试
查看云托管日志，确认：
- ✅ 数据库连接成功
- ✅ 服务正常启动
- ✅ 端口监听正常

## 🔧 Dockerfile 优化说明

### 主要改进

1. **使用 Node.js 18 官方镜像**
   - 之前：`alpine:3.13` + 手动安装 Node.js
   - 现在：`node:18-alpine`（包含完整的 Node.js 环境）

2. **优化构建层次**
   - 先复制 `package.json`
   - 安装依赖
   - 再复制源代码
   - 充分利用 Docker 缓存层

3. **生产环境优化**
   ```dockerfile
   ENV NODE_ENV=production
   npm install --production --no-audit --no-fund
   npm cache clean --force
   ```

4. **添加健康检查**
   ```dockerfile
   HEALTHCHECK --interval=30s --timeout=3s CMD node -e "..."
   ```

5. **端口统一为 80**
   - 符合云托管规范
   - 简化配置

### 镜像大小对比
- 优化前：~150MB
- 优化后：~100MB

## 🐛 常见问题排查

### 问题 1：构建失败 - Layer already exists
**原因**：Docker 层缓存问题

**解决方案**：
1. 在云托管控制台选择"清除构建缓存"
2. 重新触发构建

### 问题 2：容器启动失败
**排查步骤**：
1. 查看云托管日志
2. 检查环境变量是否配置完整
3. 确认数据库内网地址是否正确
4. 检查端口配置（应该是 80）

### 问题 3：健康检查失败
**可能原因**：
- `/health` 接口未实现
- 端口配置错误
- 启动时间过长

**解决方案**：
```javascript
// 确保 app.js 中有健康检查接口
app.get('/health', (req, res) => {
  res.json({ status: 'healthy', timestamp: Date.now() })
})
```

### 问题 4：数据库连接失败
**检查清单**：
- ✅ 使用数据库**内网地址**（不是外网）
- ✅ 数据库白名单已添加云托管服务
- ✅ 用户名密码正确
- ✅ 数据库名称正确

### 问题 5：环境变量读取失败
**确认事项**：
1. 在云托管控制台配置了环境变量
2. 变量名拼写正确（区分大小写）
3. 重启服务使环境变量生效

## 📊 性能监控

### 查看日志
1. 进入云托管控制台
2. 选择"日志查询"
3. 选择时间范围
4. 查看启动日志和错误日志

### 监控指标
- CPU 使用率
- 内存使用率
- 请求成功率
- 响应时间

## 🔄 更新部署

### 代码更新流程
```bash
# 1. 修改代码
# 2. 本地测试
npm start

# 3. 提交代码
git add .
git commit -m "修复: 描述修改内容"
git push origin main

# 4. 在云托管控制台触发构建
# 5. 查看部署日志
# 6. 验证功能
```

### 回滚操作
如果新版本有问题：
1. 在云托管控制台
2. 进入"版本管理"
3. 选择上一个稳定版本
4. 点击"切换版本"

## 📝 最佳实践

### 1. 环境隔离
- 开发环境：本地 + 外网数据库
- 生产环境：云托管 + 内网数据库

### 2. 配置管理
- 敏感信息使用环境变量
- 不要在代码中硬编码密钥
- `.env` 文件不要提交到 Git

### 3. 日志记录
```javascript
// 重要操作记录日志
console.log('[部署] 应用启动成功，端口:', port)
console.error('[错误] 数据库连接失败:', error)
```

### 4. 安全检查
- ✅ JWT_SECRET 修改为强密码
- ✅ CORS 配置具体域名
- ✅ 数据库使用参数化查询
- ✅ 定期更新依赖包

### 5. 备份策略
- 定期备份数据库
- 保留多个历史版本
- 重要更新前先备份

## 📞 技术支持

### 官方文档
- [微信云托管文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloudrun/)
- [Docker 官方文档](https://docs.docker.com/)
- [Node.js 官方文档](https://nodejs.org/docs/)

### 常用命令
```bash
# 查看本地 Docker 镜像
docker images

# 构建本地镜像（测试）
docker build -t my-app .

# 运行本地容器
docker run -p 80:80 --env-file .env my-app

# 查看运行中的容器
docker ps

# 查看容器日志
docker logs <container-id>
```

## 🎯 检查清单

部署前确认：
- [ ] Dockerfile 已优化
- [ ] .dockerignore 已配置
- [ ] package.json 依赖完整
- [ ] 环境变量已准备
- [ ] 数据库已创建
- [ ] 代码已提交到 Git
- [ ] 健康检查接口已实现

部署后验证：
- [ ] 健康检查通过
- [ ] 数据库连接成功
- [ ] API 接口正常
- [ ] WebSocket 连接正常
- [ ] 日志无错误
- [ ] 性能指标正常

---

**最后更新**：2025-11-08
**适用版本**：v1.0.0+

