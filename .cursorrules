# CloudBase 云托管小程序后端项目 - Cursor Rules

## 项目概述
这是一个基于 Express + MySQL 的微信小程序后端服务框架，适配腾讯云 CloudBase 云托管部署。
主要功能包括用户认证、JWT鉴权、文章管理等核心功能。

## 技术栈
- **框架**: Express 4.x
- **数据库**: MySQL 5.7+ (使用 mysql2)
- **认证**: JWT (jsonwebtoken)
- **小程序**: 微信小程序登录对接
- **部署**: 腾讯云 CloudBase 云托管 + Docker

## 编码规范

### 通用规范
1. **模块系统**: 使用 CommonJS (require/module.exports)，不使用 ES6 模块
2. **异步处理**: 统一使用 async/await，避免使用回调函数和 Promise.then
3. **注释语言**: 所有注释、错误消息、响应消息统一使用中文
4. **代码风格**: 
   - 使用 2 空格缩进
   - 语句末尾不加分号（除非必要）
   - 字符串优先使用单引号
   - 对象和数组最后一项不加逗号

### 文件和目录结构
```
项目根目录/
├── bin/              # 启动脚本
├── config/           # 配置文件
├── middleware/       # 中间件
├── routes/           # 路由文件
├── utils/            # 工具函数
├── scripts/          # 脚本文件
├── public/           # 静态资源
├── views/            # 视图模板
├── miniapp-example/  # 小程序示例代码
└── app.js            # 应用入口
```

### 路由规范
1. **路由文件**: 放在 `routes/` 目录下，使用 Express Router
2. **API路径**: 遵循 RESTful 规范
   - GET - 获取资源
   - POST - 创建资源
   - PUT - 更新资源
   - DELETE - 删除资源
3. **路由命名**: 使用小写字母和连字符，如 `/api/auth/login`
4. **路由组织**: 
   ```javascript
   const express = require('express');
   const router = express.Router();
   
   /**
    * 功能描述
    * HTTP方法 路由路径
    */
   router.post('/login', async (req, res) => {
     // 实现代码
   });
   
   module.exports = router;
   ```

### 响应格式规范
1. **统一响应**: 必须使用 `utils/response.js` 中的辅助函数
2. **可用函数**:
   - `success(res, data, message)` - 成功响应 (code: 0)
   - `error(res, message, code, statusCode)` - 失败响应
   - `badRequest(res, message)` - 参数错误 (code: 400)
   - `unauthorized(res, message)` - 未授权 (code: 401)
   - `forbidden(res, message)` - 无权限 (code: 403)
   - `notFound(res, message)` - 资源不存在 (code: 404)
   - `serverError(res, message)` - 服务器错误 (code: 500)

3. **响应格式**:
   ```javascript
   {
     "code": 0,           // 0表示成功，其他表示错误
     "message": "操作成功",
     "data": {},          // 响应数据
     "timestamp": 1699200000000
   }
   ```

4. **使用示例**:
   ```javascript
   const { success, badRequest, serverError } = require('../utils/response');
   
   // 成功响应
   return success(res, { userId: 123 }, '操作成功');
   
   // 参数错误
   if (!code) {
     return badRequest(res, '缺少登录code');
   }
   
   // 服务器错误
   return serverError(res, '操作失败');
   ```

### 数据库规范
1. **连接管理**: 使用 `config/database.js` 中的连接池
2. **查询执行**: 使用 `query` 函数
   ```javascript
   const { query } = require('../config/database');
   
   // 查询示例
   const users = await query(
     'SELECT * FROM users WHERE openid = ?',
     [openid]
   );
   ```

3. **参数化查询**: 必须使用参数化查询防止SQL注入
   ```javascript
   // ✅ 正确 - 使用参数化查询
   await query('SELECT * FROM users WHERE id = ?', [userId]);
   
   // ❌ 错误 - 字符串拼接
   await query(`SELECT * FROM users WHERE id = ${userId}`);
   ```

4. **事务处理**: 需要事务时使用 connection.beginTransaction()
5. **字段命名**: 数据库字段使用 snake_case，如 `created_at`
6. **时间戳**: 使用 MySQL 的 `NOW()` 函数或 `CURRENT_TIMESTAMP`

### 认证和授权规范
1. **JWT认证**: 使用 `utils/jwt.js` 中的工具函数
   ```javascript
   const { generateToken, verifyToken } = require('../utils/jwt');
   
   // 生成token
   const token = generateToken({ userId: user.id, openid: user.openid });
   
   // 验证token
   const decoded = verifyToken(token);
   ```

2. **认证中间件**: 使用 `middleware/auth.js`
   - `authenticate` - 强制认证，未登录返回401
   - `optionalAuth` - 可选认证，不强制要求登录

3. **路由保护**: 需要认证的路由必须使用中间件
   ```javascript
   const { authenticate } = require('../middleware/auth');
   
   // 需要认证的路由
   router.get('/profile', authenticate, async (req, res) => {
     // req.user 包含当前用户信息
     // req.userId 包含当前用户ID
   });
   ```

4. **Token传递**: 
   - 请求头: `Authorization: Bearer {token}`
   - 或: `token: {token}`

### 错误处理规范
1. **异常捕获**: 所有 async 函数必须使用 try-catch
   ```javascript
   router.post('/login', async (req, res) => {
     try {
       // 业务逻辑
     } catch (error) {
       console.error('登录错误:', error);
       return serverError(res, error.message || '登录失败');
     }
   });
   ```

2. **错误日志**: 使用 `console.error` 记录错误，包含上下文信息
3. **全局错误处理**: 由 `middleware/errorHandler.js` 统一处理

### 微信小程序对接规范
1. **登录流程**:
   ```javascript
   // 使用 utils/wechat.js 中的工具函数
   const { code2Session } = require('../utils/wechat');
   
   // 通过code获取openid
   const { openid, sessionKey, unionid } = await code2Session(code);
   ```

2. **用户标识**: 使用 `openid` 作为用户唯一标识
3. **session_key**: 每次登录都要更新 session_key

### 配置管理规范
1. **环境变量**: 使用 `.env` 文件，由 `dotenv` 加载
2. **配置访问**: 通过 `config/index.js` 统一访问
   ```javascript
   const config = require('../config');
   
   // 访问配置
   const appId = config.wechat.appId;
   const dbHost = config.database.host;
   ```

3. **敏感信息**: 数据库密码、API密钥等必须使用环境变量
4. **不同环境**: 通过环境变量区分开发/生产环境

### 安全规范
1. **SQL注入**: 必须使用参数化查询
2. **XSS防护**: 输出时转义特殊字符
3. **CORS配置**: 生产环境配置具体域名白名单
4. **JWT密钥**: 生产环境必须修改 JWT_SECRET
5. **密码存储**: 不要在代码中硬编码密码
6. **用户状态**: 检查用户 status 字段，禁用用户不能操作
7. **权限验证**: 修改/删除资源时验证所有权

### 性能优化规范
1. **数据库连接**: 使用连接池，不要频繁创建连接
2. **索引优化**: 常用查询字段添加索引（openid、user_id等）
3. **分页查询**: 列表接口必须支持分页
   ```javascript
   const page = parseInt(req.query.page) || 1;
   const pageSize = parseInt(req.query.pageSize) || 10;
   const offset = (page - 1) * pageSize;
   ```

4. **软删除**: 重要数据使用软删除（status字段）而非物理删除

### 日志规范
1. **登录日志**: 记录用户登录时间和IP
2. **操作日志**: 重要操作使用 `console.log` 记录
3. **错误日志**: 错误必须使用 `console.error` 记录
4. **日志格式**: 包含时间戳、操作类型、用户信息等

### 接口文档规范
1. **接口注释**: 每个接口必须包含:
   ```javascript
   /**
    * 小程序登录
    * POST /api/auth/login
    * 
    * 请求参数:
    * - code: 微信登录code
    * 
    * 返回数据:
    * - token: JWT token
    * - isNewUser: 是否新用户
    * - userInfo: 用户信息
    */
   ```

2. **参数验证**: 必须验证必需参数
3. **响应示例**: 接口文档中包含完整的请求/响应示例

## 新增功能开发流程

### 1. 创建数据库表
- 在 `scripts/init-db.sql` 中添加表结构
- 字段命名使用 snake_case
- 包含 `created_at` 和 `updated_at` 时间戳
- 添加必要的索引

### 2. 创建路由文件
- 在 `routes/` 目录创建对应的路由文件
- 使用 Express Router
- 添加详细的注释说明

### 3. 编写业务逻辑
- 参数验证（必需参数检查）
- 数据库操作（使用参数化查询）
- 错误处理（try-catch）
- 返回统一格式响应

### 4. 添加认证保护
- 需要登录的接口使用 `authenticate` 中间件
- 验证用户权限（是否可以操作该资源）

### 5. 注册路由
- 在 `app.js` 中注册新路由
- 遵循现有路由命名规范

### 6. 更新文档
- 在 `API.md` 中添加接口文档
- 包含请求参数、响应格式、小程序调用示例

## 常见场景代码模板

### 创建资源接口
```javascript
router.post('/create', authenticate, async (req, res) => {
  try {
    const { title, content } = req.body;
    const userId = req.userId;

    // 参数验证
    if (!title || !content) {
      return badRequest(res, '标题和内容不能为空');
    }

    // 创建资源
    const result = await query(
      'INSERT INTO table_name (user_id, title, content) VALUES (?, ?, ?)',
      [userId, title, content]
    );

    return success(res, { id: result.insertId }, '创建成功');
  } catch (error) {
    console.error('创建资源错误:', error);
    return serverError(res, '创建失败');
  }
});
```

### 获取列表接口
```javascript
router.get('/list', async (req, res) => {
  try {
    const page = parseInt(req.query.page) || 1;
    const pageSize = parseInt(req.query.pageSize) || 10;
    const offset = (page - 1) * pageSize;

    // 查询列表
    const items = await query(
      'SELECT * FROM table_name WHERE status = 1 ORDER BY created_at DESC LIMIT ? OFFSET ?',
      [pageSize, offset]
    );

    // 查询总数
    const countResult = await query(
      'SELECT COUNT(*) as total FROM table_name WHERE status = 1'
    );

    return success(res, {
      list: items,
      pagination: {
        page,
        pageSize,
        total: countResult[0].total
      }
    });
  } catch (error) {
    console.error('获取列表错误:', error);
    return serverError(res, '获取列表失败');
  }
});
```

### 更新资源接口
```javascript
router.put('/:id', authenticate, async (req, res) => {
  try {
    const { id } = req.params;
    const { title, content } = req.body;
    const userId = req.userId;

    // 查询资源
    const items = await query(
      'SELECT * FROM table_name WHERE id = ?',
      [id]
    );

    if (items.length === 0) {
      return notFound(res, '资源不存在');
    }

    // 权限验证
    if (items[0].user_id !== userId) {
      return forbidden(res, '无权操作');
    }

    // 更新资源
    await query(
      'UPDATE table_name SET title = ?, content = ?, updated_at = NOW() WHERE id = ?',
      [title, content, id]
    );

    return success(res, null, '更新成功');
  } catch (error) {
    console.error('更新资源错误:', error);
    return serverError(res, '更新失败');
  }
});
```

### 删除资源接口（软删除）
```javascript
router.delete('/:id', authenticate, async (req, res) => {
  try {
    const { id } = req.params;
    const userId = req.userId;

    // 查询资源
    const items = await query(
      'SELECT * FROM table_name WHERE id = ?',
      [id]
    );

    if (items.length === 0) {
      return notFound(res, '资源不存在');
    }

    // 权限验证
    if (items[0].user_id !== userId) {
      return forbidden(res, '无权操作');
    }

    // 软删除（修改status为2）
    await query(
      'UPDATE table_name SET status = 2, updated_at = NOW() WHERE id = ?',
      [id]
    );

    return success(res, null, '删除成功');
  } catch (error) {
    console.error('删除资源错误:', error);
    return serverError(res, '删除失败');
  }
});
```

## 部署相关

### Docker 部署
1. 使用项目中的 `Dockerfile`
2. 基础镜像: `node:14-alpine`
3. 工作目录: `/app`
4. 暴露端口: 80

### 环境变量配置
生产环境必须配置的环境变量:
- `DB_HOST` - 数据库地址（内网地址）
- `DB_PORT` - 数据库端口
- `DB_USER` - 数据库用户名
- `DB_PASSWORD` - 数据库密码
- `DB_NAME` - 数据库名称
- `WECHAT_APPID` - 微信小程序AppID
- `WECHAT_APPSECRET` - 微信小程序AppSecret
- `JWT_SECRET` - JWT密钥（必须修改为强密码）

### 健康检查
- 接口: `GET /health`
- 用于云托管平台的健康检测

## 开发注意事项

1. **不要提交敏感信息**: `.env` 文件不要提交到代码仓库
2. **使用内网地址**: 云托管环境使用数据库内网地址，本地开发使用外网地址
3. **JWT密钥**: 生产环境务必修改为强密码
4. **CORS配置**: 生产环境配置具体域名白名单，避免使用 `*`
5. **日志服务**: 建议接入云日志服务，便于问题排查
6. **API限流**: 生产环境建议添加接口限流保护
7. **数据备份**: 定期备份数据库数据
8. **依赖更新**: 定期更新依赖包，修复安全漏洞

## 测试规范

### 接口测试
1. 使用 Postman 或 Apifox 测试接口
2. 测试各种边界情况和异常情况
3. 验证错误处理是否正确
4. 验证响应格式是否统一

### 必测场景
- 参数缺失或错误
- 未登录访问需要认证的接口
- 越权访问（操作他人资源）
- 数据库连接失败
- Token过期或无效

## 问题排查

### 数据库连接失败
1. 检查数据库地址和端口
2. 确认用户名和密码正确
3. 云托管使用内网地址，本地使用外网地址
4. 检查数据库连接数是否耗尽

### 微信登录失败
1. 检查 AppID 和 AppSecret 配置
2. 确认 code 有效性（5分钟内使用）
3. 查看微信 API 返回的错误信息

### Token验证失败
1. 检查 JWT_SECRET 是否一致
2. 确认 token 格式正确（Bearer token）
3. 检查 token 是否过期
4. 确认用户状态是否正常

## AI编码助手使用建议

在使用 AI 编写代码时:

1. **提供清晰的上下文**: 说明你要实现什么功能，属于哪个模块
2. **遵循项目规范**: 要求 AI 遵循本项目的编码规范和风格
3. **代码审查**: AI 生成的代码需要人工审查，特别是:
   - 数据库查询是否使用参数化
   - 错误处理是否完善
   - 权限验证是否正确
   - 响应格式是否统一
4. **测试验证**: 必须测试 AI 生成的代码，确保功能正确

## 版本控制

### Git 规范
- 提交信息使用中文，清晰描述改动
- 合理拆分提交，避免大量文件一次提交
- 不提交 `node_modules/`、`.env` 等文件

### 提交信息格式
```
类型: 简短描述

详细描述（可选）

类型包括:
- 新增: 新增功能
- 修复: Bug修复
- 优化: 性能优化
- 重构: 代码重构
- 文档: 文档更新
- 配置: 配置修改
```

## 扩展建议

当需要新增功能时，优先考虑:
1. **文件上传**: 集成腾讯云 COS 对象存储
2. **消息推送**: 接入微信订阅消息
3. **支付功能**: 对接微信支付
4. **数据缓存**: 引入 Redis 提升性能
5. **API文档**: 使用 Swagger 自动生成
6. **单元测试**: 使用 Jest 或 Mocha
7. **日志监控**: 接入云监控服务
8. **接口限流**: 使用 express-rate-limit

---

**最后更新**: 2024-11-06
**项目版本**: v1.0.0

